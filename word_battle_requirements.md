# Word Battle 需求文档（更新版）

## 1. 项目概述

Word Battle是一个基于网页的多人在线游戏平台，允许多个用户通过不同设备同时访问并参与游戏。该平台提供游戏大厅和游戏房间两个主要功能区域。

## 2. 系统架构要求

- 多设备支持：PC、手机等设备都能通过浏览器访问
- 实时连接：使用WebSocket保持持久连接
- 响应式设计：适配不同屏幕尺寸
- 端口配置：
  - 前端固定使用3000端口
  - 后端固定使用3001端口
  - 每次重启应用时自动释放占用的端口和进程
- 开发环境：
  - 所有服务在Cursor的terminal中运行
  - 避免打开额外的命令行窗口

## 3. 功能需求

### 3.1 游戏大厅

1. **玩家身份**

   - 身份分配：
     - 每台设备首次通过WebSocket连接服务器时，由服务器顺序分配身份（player1、player2……）。
     - 服务器在分配身份后，将该身份通过WebSocket消息发送到客户端，客户端将其写入本地存储。
   - 身份持久化：
     - 客户端刷新页面后应从本地存储读取已分配身份，并在重新连接时发送该身份，服务器确认后允许继续使用。
     - 若服务器检测到该身份已被占用（例如短时间内重复连接），服务器应允许重用；否则提示冲突。
   - 多设备访问：
     - 局域网中不同设备视作独立玩家，各自分配独立身份。
     - 新设备连接时服务器需将当前所有玩家列表推送给新设备，并将该新玩家的身份和状态广播给所有在线玩家。

2. **玩家状态管理**

   - 状态类型：
     - 空闲状态：在游戏大厅中
     - 对战状态：在游戏房间中
   - 状态转换：
     - 进入大厅 -> 空闲状态
     - 创建/加入房间 -> 对战状态
     - 退出房间 -> 空闲状态
   - 状态显示：
     - 实时显示所有在线玩家的当前状态
     - 状态变化时即时更新所有用户界面

3. **实时状态显示**

   - 显示当前在线玩家列表及其状态
   - 显示所有活动的游戏房间
   - 房间或玩家状态变化需即时广播到所有用户，实现大厅列表实时更新

### 3.2 房间系统

1. **房间创建**

   - 任何玩家都可以创建新房间
   - 创建者自动成为房主
   - 创建房间不影响玩家原有身份
   - 服务器需将新房间信息广播给所有在线玩家，使大厅界面同步更新

2. **房间管理**

   - 其他玩家可以自由加入/退出房间
   - 房主退出时：
     - 若在游戏开始前退出，房间立即解散
     - 服务器需广播房间解散事件给所有在线玩家
     - 房间内其他玩家应自动退出返回大厅
     - 大厅中其他玩家应立即移除该房间显示
   - 房间解散时所有玩家状态应更新为空闲，并保持原有身份

3. **游戏开始**

   - 仅房主有权限开始游戏
   - 游戏开始时所有房间内玩家显示"Thank you"提示框

### 3.3 连接管理

1. **持久连接**

   - 保持WebSocket长连接
   - 只有关闭浏览器才断开连接
   - 在线状态持续追踪：
     - 大厅中保持在线状态
     - 进入房间保持在线状态
     - 退出房间返回大厅仍保持在线状态

2. **实时同步**

   - 新玩家加入时需推送当前所有在线玩家和房间状态给新设备
   - 房间状态或玩家状态变化需立即广播给所有在线玩家
   - 房间创建/解散事件必须实时同步更新大厅房间列表

## 4. 技术要求

### 4.1 前端要求

- 响应式Web界面
- 实时状态更新
- 无刷新页面切换
- 本地存储实现身份持久化

### 4.2 后端要求

- WebSocket服务器
- 房间状态管理
- 玩家会话管理
- 高效的端口管理和进程控制

### 4.3 通信要求

- 实时双向通信
- 低延迟数据同步
- 可靠的连接状态检测
- 玩家身份持久化机制

## 5. 用户流程

1. 用户访问应用URL
2. 检查本地存储是否有已存在的身份
   - 有：使用已存在的身份
   - 无：自动分配新身份并存储
3. 进入游戏大厅（空闲状态）
4. 可以选择：
   - 创建新房间（转为对战状态）
   - 加入现有房间（转为对战状态）
5. 在房间中可以：
   - 等待游戏开始（普通玩家）
   - 开始游戏（房主）
   - 退出房间（返回空闲状态）
6. 游戏结束或房间解散后返回大厅（空闲状态）

## 6. 错误处理

- 断线重连机制：刷新页面或临时断线后可自动重连并恢复状态
- 房主意外断线的房间解散处理：房间应立即解散，并广播事件给所有在线玩家
- 异常状态自动恢复
- 端口占用自动处理机制

## 7. 性能要求

- 支持至少10个同时在线用户（多设备连接应统计为独立玩家）
- 消息延迟不超过500ms
- 页面加载时间不超过3秒

## 8. 局域网调试指南

- 后端服务启动时需监听0.0.0.0或你的电脑局域网IP，而非127.0.0.1。例如：
  ```js
  app.listen(3001, '0.0.0.0', () => console.log('Server running...'));
  ```
- 在手机上访问电脑的局域网IP，例如：
  ```
  http://192.168.1.15:3000
  ```
- 在前端创建WebSocket连接时，WebSocket地址应指向局域网IP，而非localhost。例如：
  ```js
  const socket = new WebSocket(`ws://${window.location.hostname}:3001`);
  ```
- 若无法访问，检查并关闭防火墙或对3000/3001端口放行。

---

以上更新确保多台设备可独立分配身份，并且在局域网环境中所有设备均能实时看到大厅和房间状态变化，实现流畅的多人游戏体验。

